<!DOCTYPE html>
<html lang="ko" xmlns:th="https://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPet</title>
    <link rel="stylesheet" href="/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <th:block th:replace = "fragment/header :: headerStyle"></th:block>
</head>
<body>

<th:block th:replace = "fragment/header :: header"></th:block>

<div class="container">

    <div class="search-container">
        <div class="search-wrapper">
            <input type="text" class="search-box" id="searchInput" placeholder="ê²Œì‹œë¬¼, ì¥ì†Œ, ì‚¬ìš©ì ê²€ìƒ‰...">
            <i class="fas fa-search search-icon"></i>
            <button class="clear-btn" id="clearBtn"><i class="fas fa-times-circle"></i></button>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ë²„íŠ¼ -->
    <div class="write-button-container">
        <div class="category-filter">
            <button class="category-btn active" data-category="all">ì „ì²´</button>
            <button class="category-btn" data-category="ê°•ì•„ì§€">ê°•ì•„ì§€</button>
            <button class="category-btn" data-category="ê³ ì–‘ì´">ê³ ì–‘ì´</button>
            <button class="category-btn" data-category="ê³µì›">ê³µì›</button>
            <button class="category-btn" data-category="ì¹´í˜">ì¹´í˜</button>
            <button class="category-btn" data-category="íŒ">íŒ</button>
<!--            <button class="category-btn" data-category="etc">ê¸°íƒ€</button>-->
        </div>
        <a href="/addpost" style="text-decoration-line: none"><button class="write-btn">ê¸€ì“°ê¸°</button></a>
    </div>

    <div class="masonry-grid">

        <!-- í¬ìŠ¤íŠ¸ ì¹´ë“œ -->
        <div class="post-card" th:each="post : ${postings}" th:attr = "data-value = ${post.rid}, data-title = ${post.title}" >
            <div class="post-card-header">
                <div class="post-card-avatar"><img src="https://ssoads.co.kr/common/img/default_profile.png" alt=""></div>
                <div class="post-card-username" th:text="${post.nickname}"></div>
            </div>
            <img th:src="@{|/upload/${post.storedFileName}|}" class="post-card-image" alt="ì¹´í˜ ì¸í…Œë¦¬ì–´">
            <div class="post-card-content">
                <div class="post-card-location">ì„œìš¸ ë§ˆí¬êµ¬</div>
                <div class="post-card-title" th:text="${post.title}"></div>
                <div class="post-card-description" th:text="${post.content}" ></div>
            </div>

            <div class="post-card-actions">
                <button class="action-btn like-btn" onclick="toggleLikes(event, this)">
                    <i class="far fa-heart"></i> <span class="like-count" th:text="${post.likes}">0</span>
                </button>
                <button class="action-btn"><i class="far fa-comment"></i></button>
                <button class="action-btn bookmark" id="bookmark-btn" onclick="toggleBooks(event, this)"><i class="far fa-bookmark"></i></button>
            </div>
        </div>
    </div>
    <div class="no-results" id="noResults">
        <i class="fas fa-search"></i>
        <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<button class="fab" onclick="toggleChat()"><i class="fas fa-comment"></i></button>
<div class="chat-popup" id="chatPopup">
    <div class="chat-header">
        <div class="chat-header-left">
            <button class="chat-back-btn" onclick="toggleChat()">â†</button>
            <div class="chat-avatar"><i class="fas fa-paw"></i></div>
            <div class="chat-info">
                <h3>ì—ë¸Œë¦¬ì• ë‹ˆë©€</h3>
                <p>MyPetë§Œì˜ ë§ì¶¤í˜• AI ë¹„ì„œ</p>
            </div>
        </div>
        <button class="chat-menu-btn">â‹®</button>
    </div>

    <div class="chat-body" id="chatBody">
        <div class="message-info">íŠ¹ë³„í•œ ë°˜ë ¤ë™ë¬¼ ë¼ì´í”„ì˜ ì‹œì‘ì„ ìœ„í•œ ì—ë¸Œë¦¬ì• ë‹ˆë©€</div>

        <div class="chat-message received">
            <div class="message-bubble">ì•ˆë…•í•˜ì„¸ìš”,<br>ì—ë¸Œë¦¬ì• ë‹ˆë©€ AI ë¹„ì„œì…ë‹ˆë‹¤.<br>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
             <div class="message-time">ë°©ê¸ˆ ì „</div>
        </div>


<!--        <div class="chat-message received">-->
<!--            <div class="typing-indicator">-->
<!--                 <div class="message-bubble">Ai ì…ë ¥ ì¤‘</div>-->
<!--                <div class="typing-dot"></div>-->
<!--                <div class="typing-dot"></div>-->
<!--                <div class="typing-dot"></div>-->
<!--            </div>-->
<!--        </div>-->

    </div>

    <div class="chat-footer">
        <!-- <button class="attach-btn">ğŸ“</button> -->
        <div class="chat-input-wrapper">
            <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." id="chatInput">
        </div>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script th:inline="javascript">
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const postGrid = document.getElementById('postGrid');
    const noResults = document.getElementById('noResults');

    function toggleChat() {
        const chatPopup = document.getElementById('chatPopup');
        chatPopup.classList.toggle('active');
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (message) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message sent';

            const now = new Date();
            const timeStr = `ì˜¤í›„ ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

            messageDiv.innerHTML = `
                    <div class="message-bubble">${message}</div>
                    <div class="message-time">${timeStr}</div>
                `;

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;

            input.value = '';
            showTypingIndicator();
            const response = await fetch("/gpt", {
                method : "POST",
                headers : {
                    "Content-Type" : "application/json"
                },
                body: JSON.stringify({"prompt" : message})
            })

            if(response.ok){
                const res = await response.json()
                hideTypingIndicator();
                if(res['status'] == "ok"){
                    const prompt = res['prompt']
                    addAIResponse(prompt)
                }
            }
            else{
                console.log("Failed to connecting to server")
                hideTypingIndicator();
            }

            // AI ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜
            // setTimeout(() => {
            //     showTypingIndicator();
            //     setTimeout(() => {
            //         hideTypingIndicator();
            //         addAIResponse('ë„¤, ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ì–´ë–¤ ë‚´ìš©ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?');
            //     }, 2000);
            // }, 500);
        }
    }

    function showTypingIndicator() {
        const chatBody = document.getElementById('chatBody');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message received';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
        chatBody.appendChild(typingDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function addAIResponse(text) {
        const chatBody = document.getElementById('chatBody');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message received';

        const now = new Date();
        const timeStr = `ì˜¤í›„ ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

        messageDiv.innerHTML = `
                <div class="message-bubble">${text}</div>
                <div class="message-time">${timeStr}</div>
            `;

        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });


    const toggleBooks = async(event, btn) => {
        const postcard = btn.closest('.post-card')
        const post_id = postcard.getAttribute('data-value')
        // console.log(post_id)
        event.stopPropagation();
        let isMarked = 1;
        const icon = btn.querySelector('i');
        if(icon.classList.contains('far')){
            icon.classList.remove('far')
            icon.classList.add('fas') // ë¶ë§ˆí¬ ì¶”ê°€
        }
        else{
            icon.classList.remove('fas')
            icon.classList.add('far')
            isMarked = 0
        }
        const response = await fetch("/bookmark", {
            method : "POST",
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify({"status" : isMarked, "post_id" : post_id})
        })
        if(response.ok){
            const res = await response.json()
            console.log(res);
            if(res['status'] == "no"){
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤!")
                location.href = "/login"
            }
        }
        else{
            console.log("failed to connecting server")
        }

    }

    async function toggleLikes (event, btn) {
        const postcard = btn.closest('.post-card')
        const post_id = postcard.getAttribute('data-value')
        console.log(post_id)
        event.stopPropagation();
        let isLiked = 1 ;

        const icon = btn.querySelector('i');
        const countSpan = btn.querySelector('.like-count');
        let count = parseInt(countSpan.textContent);

        if (btn.classList.contains('liked')) {
            icon.classList.remove('fas');
            icon.classList.add('far');
            btn.classList.remove('liked');
            isLiked = 0
            if(count > 0) count--;
        } else {
            icon.classList.remove('far');
            icon.classList.add('fas');
            btn.classList.add('liked');
            isLiked = 1
            count++;
        }
        countSpan.textContent = count;

        const response = await fetch("/like", {
            method : "POST",
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify({"status" : isLiked, "post_id" : post_id})
        })
        if(response.ok){
            const res = await response.json()
            console.log(res);
            if(res['status'] == "no"){
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤!")
                location.href = "/login"
            }
        }
        else{
            console.log("failed to connecting server")
        }
    }
    // ê° ì‚¬ìš©ìë§ˆë‹¤ì˜ ì´ì „ ìƒí˜¸ì‘ìš© ì—¬ë¶€
    const likePostIds = [[${Likes}]]
    const bookMarkPostIds = [[${BookMarks}]]
    const likeset = new Set(likePostIds)
    const bookmarkSet = new Set(bookMarkPostIds)
    document.addEventListener('DOMContentLoaded', () => {
        const postCards = document.querySelectorAll(".post-card")
        console.log("the like set is " + likeset)

        postCards.forEach(element => {
            const postId = parseInt(element.dataset.value)
            if(likeset.has(postId)){
                const btn = element.querySelector(".action-btn")
                const icon = btn.querySelector('i');
                const countSpan = btn.querySelector('.like-count');
                icon.classList.remove('far');
                icon.classList.add('fas');
                btn.classList.add('liked');
            }
            if(bookmarkSet.has(postId)){
                const btn = element.querySelector('#bookmark-btn')
                const icon = btn.querySelector('i')
                icon.classList.remove('far')
                icon.classList.add('fas') // ë¶ë§ˆí¬ ì¶”ê°€
            }
        })
    })

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();

        // í´ë¦¬ì–´ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (searchTerm) {
            clearBtn.classList.add('active');
        } else {
            clearBtn.classList.remove('active');
        }

        // ê²€ìƒ‰ í•„í„°ë§
        const cards = document.querySelectorAll('.post-card');
        let visibleCount = 0;

        cards.forEach(card => {
            const title = card.dataset.title.toLowerCase();

            console.log(title)
            if (title.includes(searchTerm) ) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€
        if (visibleCount === 0 && searchTerm) {
            noResults.classList.add('active');
            postGrid.style.display = 'none';
        } else {
            noResults.classList.remove('active');
            postGrid.style.display = '';
        }
    });

    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearBtn.classList.remove('active');

        document.querySelectorAll('.post-card').forEach(card => {
            card.style.display = '';
        });

        noResults.classList.remove('active');
        postGrid.style.display = '';
        searchInput.focus();
    });

    let currentCategory = 'all';
    const categoryBtns = document.querySelectorAll('.category-btn');
    categoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            categoryBtns.forEach(b => b.classList.remove('active'));
            // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            this.classList.add('active');

            currentCategory = this.dataset.category;
            filterPosts();
        });
    });

    // í¬ìŠ¤íŠ¸ í•„í„°ë§ í•¨ìˆ˜
    function filterPosts() {
        const cards = document.querySelectorAll('.post-card');
        let visibleCount = 0;

        cards.forEach(card => {
            const title = card.dataset.title.toLowerCase();


            // ì¹´í…Œê³ ë¦¬ í•„í„° ì²´í¬
            const categoryMatch = currentCategory === 'all' || title.includes(currentCategory)

            if (categoryMatch) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€
        if (visibleCount === 0) {
            noResults.classList.add('active');
            postGrid.style.display = 'none';
        } else {
            noResults.classList.remove('active');
            postGrid.style.display = '';
        }
    }



    // ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', function (e) {
            if (!e.target.closest('.action-btn')) {
                const title = this.querySelector('.post-card-title').textContent;
                const value = card.dataset.value;
                const ridValue = parseInt(value)
                console.log("value : " + value)

                // alert(`"${title}" í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™`);
                window.location.href = `/postings/${ridValue}`
            }
        });
    });



    // ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ì „í™˜
    document.querySelectorAll('.sub-nav-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.sub-nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
    document.querySelectorAll('.header-nav-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.header-nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
</script>
</body>
</html>