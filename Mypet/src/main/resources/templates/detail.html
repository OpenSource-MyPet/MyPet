<!DOCTYPE html>
<html lang="ko" xmlns:th="https://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPet</title>
    <link rel="stylesheet" href="/detail.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <th:block th:replace = "fragment/header :: headerStyle"></th:block>
</head>
<body>
<th:block th:replace = "fragment/header :: header"></th:block>


<div class="container">
    <button class="back-btn" onclick="goBack()">
        â† ëª©ë¡ìœ¼ë¡œ
    </button>

    <div class="post-detail-card" th:attr="data-value = ${detail.rid}">
        <!-- ì‘ì„±ì ì •ë³´ -->
        <div class="post-author">
            <div class="post-author-avatar">
                <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="í”„ë¡œí•„">
            </div>
            <div class="post-author-info">
                <div class="post-author-name" th:text = "${detail.nickname}"></div>
                <div class="post-author-location">ì„œìš¸ ë§ˆí¬êµ¬</div>
            </div>
            <div class="post-author-time">2ì‹œê°„ ì „</div>
        </div>

        <!-- ê²Œì‹œê¸€ ì´ë¯¸ì§€ -->
        <img th:src="@{|/upload/${detail.storedFileName}|}" class="post-image" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">

        <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
        <div class="post-content">
            <h1 class="post-title" th:text = "${detail.title}"></h1>
            <div class="post-description" th:text = "${detail.content}"></div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="post-actions">
            <button class="action-btn like-btn" id="like-btn" onclick="toggleLikes(event,this)">
                <i class="far fa-heart"></i> <span class="like-count" th:text="${detail.likes}">0</span>
            </button>
            <button class="action-btn"><i class="far fa-comment" ></i> <span th:text="${detail.comments}">8</span></button>
            <button class="action-btn bookmark" id="bookmark-btn" onclick="toggleBooks(event, this)"><i class="far fa-bookmark"></i></button>
        </div>

        <!-- ëŒ“ê¸€ -->
        <div class="comments-section">
            <div class="comments-title" >ëŒ“ê¸€ <span th:text="${detail.comments}">10</span>ê°œ</div>

            <div class="comment-input-wrapper">
                <input type="text" class="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." id="comment-input">
                <button class="comment-submit-btn" onclick="addComment()">ì‘ì„±</button>
            </div>

            <div class="comment-list" id="comment-list" >
                <div class="comment-item" th:each="comment : ${comments}">
                    <div class="comment-avatar"><img src="https://ssoads.co.kr/common/img/default_profile.png" alt=""></div>
                    <div class="comment-content">
                        <div class="comment-author" th:text="${comment.nickname}">í”¼ìë§¤ë‹ˆì•„</div>
                        <div class="comment-text" th:text="${comment.comments}">ì €ë„ ê°€ê³  ì‹¶ì–´ìš”! ì£¼ë§ì— ì‹œê°„ ê´œì°®ì„ ê²ƒ ê°™ì•„ìš”~</div>
                        <div class="comment-time" th:text="${comment.createdAtFormat}">1ì‹œê°„ ì „</div>
                    </div>
                </div>

<!--                <div class="comment-item">-->
<!--                    <div class="comment-avatar"><img src="https://ssoads.co.kr/common/img/default_profile.png" alt=""></div>-->
<!--                    <div class="comment-content">-->
<!--                        <div class="comment-author">ì¡°ê¹…í•˜ì‹œë‹¤</div>-->
<!--                        <div class="comment-text">ì¹´í˜ ìœ„ì¹˜ ì–´ë””ì¸ê°€ìš”?</div>-->
<!--                        <div class="comment-time">50ë¶„ ì „</div>-->
<!--                    </div>-->
<!--                </div>-->

<!--                <div class="comment-item">-->
<!--                    <div class="comment-avatar">ğŸ±</div>-->
<!--                    <div class="comment-content">-->
<!--                        <div class="comment-author">ê³ ì–‘ì´ì§‘ì‚¬</div>-->
<!--                        <div class="comment-text">ì‚¬ì§„ë§Œ ë´ë„ ë¶„ìœ„ê¸° ì¢‹ë„¤ìš”! ì €ë„ ì°¸ì—¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤ ã…ã…</div>-->
<!--                        <div class="comment-time">30ë¶„ ì „</div>-->
<!--                    </div>-->
<!--                </div>-->
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">

    const toggleBooks = async(event, btn) => {
        const postcard = btn.closest('.post-detail-card')
        const post_id = postcard.getAttribute('data-value')
        // console.log(post_id)
        event.stopPropagation();
        let isMarked = 1;
        const icon = btn.querySelector('i');
        if(icon.classList.contains('far')){
            icon.classList.remove('far')
            icon.classList.add('fas') // ë¶ë§ˆí¬ ì¶”ê°€
        }
        else{
            icon.classList.remove('fas')
            icon.classList.add('far')
            isMarked = 0
        }
        const response = await fetch("/bookmark", {
            method : "POST",
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify({"status" : isMarked, "post_id" : post_id})
        })
        if(response.ok){
            const res = await response.json()
            console.log(res);
            if(res['status'] == "no"){
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤!")
                location.href = "/login"
            }
        }
        else{
            console.log("failed to connecting server")
        }

    }

    async function toggleLikes (event, btn) {
        const postcard = btn.closest('.post-detail-card')
        const post_id = postcard.getAttribute('data-value')
        console.log(post_id)
        event.stopPropagation();
        let isLiked = 1 ;

        const icon = btn.querySelector('i');
        const countSpan = btn.querySelector('.like-count');
        let count = parseInt(countSpan.textContent);

        if (btn.classList.contains('liked')) {
            icon.classList.remove('fas');
            icon.classList.add('far');
            btn.classList.remove('liked');
            isLiked = 0
            if(count > 0) count--;
        } else {
            icon.classList.remove('far');
            icon.classList.add('fas');
            btn.classList.add('liked');
            isLiked = 1
            count++;
        }
        countSpan.textContent = count;

        const response = await fetch("/like", {
            method : "POST",
            headers : {
                'Content-Type' : 'application/json'
            },
            body : JSON.stringify({"status" : isLiked, "post_id" : post_id})
        })
        if(response.ok){
            const res = await response.json()
            console.log(res);
            if(res['status'] == "no"){
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤!")
                location.href = "/login"
            }
        }
        else{
            console.log("failed to connecting server")
        }
    }

    // ê° ì‚¬ìš©ìë§ˆë‹¤ì˜ ì´ì „ ìƒí˜¸ì‘ìš© ì—¬ë¶€
    const likePostIds = [[${Likes}]]
    const bookMarkPostIds = [[${BookMarks}]]
    const likeset = new Set(likePostIds)
    const bookmarkSet = new Set(bookMarkPostIds)
    document.addEventListener('DOMContentLoaded', () => {
        const postCards = document.querySelectorAll(".post-detail-card")
        console.log("the like set is " + likeset)

        postCards.forEach(element => {
            const postId = parseInt(element.dataset.value)
            if(likeset.has(postId)){
                const btn = element.querySelector("#like-btn")
                const icon = btn.querySelector('i');
                const countSpan = btn.querySelector('.like-count');
                icon.classList.remove('far');
                icon.classList.add('fas');
                btn.classList.add('liked');
            }
            if(bookmarkSet.has(postId)){
                const btn = element.querySelector('#bookmark-btn')
                const icon = btn.querySelector('i')
                icon.classList.remove('far')
                icon.classList.add('fas') // ë¶ë§ˆí¬ ì¶”ê°€
            }
        })
    })

    async function addComment() {
        const input = document.getElementById('comment-input');
        const commentText = input.value.trim();

        const postId = document.querySelector(".post-detail-card").getAttribute("data-value")
        console.log("comment rid is " + postId)
        const response = await fetch("/comments", {
            method : "POST",
            headers : {
                'Content-Type' : 'application/json'
            },
            body: JSON.stringify({"comments" : commentText, "postId" : parseInt(postId) })
        })
        if(response.ok){
            const res = await response.json()
            if(res['status'] == "no"){
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤")
                location.href = "/login"
                return;
            }
        }
        else{
            console.log("failed to connecting server")
            return;
        }

        if (commentText === '') {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        const commentList = document.getElementById('comment-list');
        const newComment = document.createElement('div');
        newComment.className = 'comment-item';
        newComment.innerHTML = `
                <div class="comment-avatar"><img src="https://ssoads.co.kr/common/img/default_profile.png" alt=""></div>
                <div class="comment-content">
                    <div class="comment-author">ë‚˜</div>
                    <div class="comment-text">${commentText}</div>
                    <div class="comment-time">ë°©ê¸ˆ ì „</div>
                </div>
            `;

        commentList.insertBefore(newComment, commentList.firstChild);
        input.value = '';

        // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
        const commentCount = document.querySelector('.comments-title');
        const currentCount = parseInt(commentCount.textContent.match(/\d+/)[0]);
        commentCount.textContent = `ëŒ“ê¸€ ${currentCount + 1}ê°œ`;

    }

    // Enter í‚¤ë¡œ ëŒ“ê¸€ ì‘ì„±
    document.getElementById('comment-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addComment();
        }
    });

    function goBack() {
        location.href = "/"
    }

    // ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ì „í™˜
    document.querySelectorAll('.header-nav-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.header-nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
</script>
</body>
</html>