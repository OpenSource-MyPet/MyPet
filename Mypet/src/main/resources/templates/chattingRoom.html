<!DOCTYPE html>
<html lang="ko" xmlns:th="https://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°© - MyPet</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <th:block th:replace = "fragment/header :: headerStyle"></th:block>
    <link rel="stylesheet" href="/chattingRoom.css">

</head>
<body>
<th:block th:replace = "fragment/header :: header"></th:block>
<!--<div class="header">-->
<!--    <div class="header-top">-->
<!--        <div class="logo">MyPet</div>-->
<!--        <div class="header-nav">-->
<!--            <span class="header-nav-item">í™ˆ</span>-->
<!--            <span class="header-nav-item">ì½˜í…ì¸ </span>-->
<!--            <span class="header-nav-item">ì‡¼í•‘</span>-->
<!--            <span class="header-nav-item active">ì»¤ë®¤ë‹ˆí‹°</span>-->
<!--            <span class="header-nav-item">ì„œë¹„ìŠ¤</span>-->
<!--            <span class="header-nav-item">í¬ë¦¬ì—ì´í„°</span>-->
<!--        </div>-->
<!--        <div class="header-actions">-->
<!--            <button class="login-btn">ë¡œê·¸ì¸</button>-->
<!--            <span class="menu-icon">â˜°</span>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<div class="main-container">
    <!-- ì±„íŒ… ì˜ì—­ -->
    <div class="chat-container" id ="chat-area" th:attr="data-roomId = ${chatRoom.roomId}">
        <!-- ì±„íŒ…ë°© í—¤ë” -->
        <div class="chat-header">
            <!-- <div class="chat-avatar">
                <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="í”„ë¡œí•„">
            </div> -->
            <div class="chat-info">
                <div class="chat-title" th:text="${chatRoom.title}">ê°•ì•„ì§€ ì‚°ì±… ëª¨ì„</div>
                <div class="chat-members" >ë©¤ë²„ <span th:text="${chatRoom.user}"></span>ëª…</div>
            </div>
            <div class="chat-menu">
                <i class="fas fa-ellipsis-v"></i>
            </div>
        </div>

        <!-- ì±„íŒ… ë©”ì‹œì§€ -->
        <div class="chat-messages" id="chatMessages">
<!--            <div class="message">-->
<!--                <div class="message-avatar">-->
<!--                    <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="">-->
<!--                </div>-->
<!--                <div class="message-content">-->
<!--                    <div class="message-sender">ì‹¤ë²„íŠ¸ (ë°˜í˜¸)</div>-->
<!--                    <div class="message-bubble">ì•„ë‹ˆìš” ë¨¼ì € ì—°ë½í•˜ì„¸ìš”</div>-->
<!--                    <div class="message-time">ì˜¤í›„ 3:45</div>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="date-divider">-->
<!--                <span>2021ë…„ 2ì›” 2ì¼</span>-->
<!--            </div>-->

<!--            <div class="message own">-->
<!--                <div class="message-content">-->
<!--                    <div class="message-bubble">ë°¥ë¨¹ì„ ë•Œ ì—°ë½í•´ë¼ ì•Œì•˜ì§€?</div>-->
<!--                    <div class="message-time">ì˜¤í›„ 3:45</div>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="message own">-->
<!--                <div class="message-content">-->
<!--                    <div class="message-bubble">ì €ë… ë¨¹ê³  ì „í™”í•˜ì</div>-->
<!--                    <div class="message-time">ì˜¤í›„ 3:45</div>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="message">-->
<!--                <div class="message-avatar">-->
<!--                    <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="">-->
<!--                </div>-->
<!--                <div class="message-content">-->
<!--                    <div class="message-sender">ì‹¤ë²„íŠ¸ (ë°˜í˜¸)</div>-->
<!--                    <div class="message-bubble">ë‚˜í•œ ì—¬ìì¹œ í•œêµ­ìê°€ ê°€ë„ˆê³ ì ìˆëŠ”ë° ~~ ë°¥ë¨¹ì„ ê±° ë‚˜ê°€ë‹ˆ ê°™ì´ ê°€ë‹ˆê¹Œ ì§§ì€ ê²ƒ ê°™ì•„ìš”~~</div>-->
<!--                    <div class="message-time">ì˜¤í›„ 3:45</div>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="message own">-->
<!--                <div class="message-content">-->
<!--                    <div class="message-bubble">ë„¤. ê·¸ë˜ ì‹œê°„ì´ ê°€ëŠ¥í•´ìš”</div>-->
<!--                    <div class="message-time">ì˜¤í›„ 3:45</div>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="message own">-->
<!--                <div class="message-content">-->
<!--                    <div class="message-bubble">ì¢‹ì‹  ëŒ€ë°•ì´ë„¤ìš” ã„·ã„·ã„· ì–´ë””ì„œ ê°€ë¥´ì³ìš”?</div>-->
<!--                    <div class="message-time">ì˜¤í›„ 3:45</div>-->
<!--                </div>-->
<!--            </div>-->
        </div>

        <!-- ì±„íŒ… ì…ë ¥ -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <!-- <div class="chat-input-icons">
                    <i class="far fa-image"></i>
                    <i class="far fa-file"></i>
                    <i class="far fa-smile"></i>
                </div> -->
                <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." id="messageInput">
                <button class="chat-send-btn" onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="sidebar-header">
            ì±„íŒ…ë°© ì •ë³´
        </div>

        <!-- ì±„íŒ…ë°© ì •ë³´ -->
        <div class="sidebar-room-info">
            <div class="sidebar-room-avatar">
                <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="">
            </div>
            <div class="sidebar-room-title" th:text="${chatRoom.title}">ê°•ì•„ì§€ ì‚°ì±… ëª¨ì„</div>
            <div class="sidebar-room-desc" th:text="${chatRoom.content}">ì„œìš¸ í•œê°•ê³µì›ì—ì„œ í•¨ê»˜ ì‚°ì±…í•´ìš”! ğŸ•</div>
        </div>

        <div class="sidebar-content">
            <!-- í†µê³„ -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">í†µê³„</div>
                <div class="sidebar-stats">
                    <div class="stat-item">
                        <div class="stat-number" th:text="${chatRoom.user}">2</div>
                        <div class="stat-label" >ì°¸ì—¬ì</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">í™œë°œ</div>
                        <div class="stat-label">ë©”ì‹œì§€</div>
                    </div>
                </div>
            </div>

            <!-- ì°¸ì—¬ì ëª©ë¡ -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">ì°¸ì—¬ì (<span th:text="${chatRoom.user}"></span>ëª…)</div>
                <div class="sidebar-members">
                    <div class="member-item">
                        <div class="member-avatar">
                            <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="">
                        </div>
                        <div class="member-info">
                            <div class="member-name" th:text="${chatRoom.userId}">ì‹¤ë²„íŠ¸ (ë°˜í˜¸)</div>
                            <div class="member-status">ğŸŸ¢ ì˜¨ë¼ì¸</div>
                        </div>
                    </div>
                    <div class="member-item">
                        <div class="member-avatar">
                            <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="">
                        </div>
                        <div class="member-info">
                            <div class="member-name">ë‚˜</div>
                            <div class="member-status">ğŸŸ¢ ì˜¨ë¼ì¸</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">ì„¤ì •</div>
                <div class="sidebar-actions">
                    <button class="sidebar-btn">
                        <i class="fas fa-bell"></i>
                        ì•Œë¦¼ ì„¤ì •
                    </button>
                    <button class="sidebar-btn">
                        <i class="fas fa-image"></i>
                        ì‚¬ì§„/íŒŒì¼ ë³´ê¸°
                    </button>
                    <button class="sidebar-btn">
                        <i class="fas fa-user-plus"></i>
                        ë©¤ë²„ ì´ˆëŒ€
                    </button>
                    <button class="sidebar-btn" style="color: #ed4956; border-color: #ed4956;">
                        <i class="fas fa-sign-out-alt"></i>
                        ì±„íŒ…ë°© ë‚˜ê°€ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const userId = /*[[${user.id}]]*/ ""
    const nickname = /*[[${user.nickname}]]*/ ""
    console.log("userid : "+ userId)
    console.log("nickname : " + nickname)
    // ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ì „í™˜
    document.querySelectorAll('.header-nav-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.header-nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });


    let stompClient = null ;
    let roomId = null ;

    // console.log(document.getElementById("chat-area").getAttribute("data-roomId"))

    let connect = () => {
        roomId = document.getElementById("chat-area").getAttribute("data-roomId")
        const socket = new SockJS('/ws')
        stompClient = Stomp.over(socket)

        stompClient.connect({}, function (frame){
            console.log("Connected : " + frame)
            stompClient.subscribe('/topic/' + roomId, function (msg){
                const message = JSON.parse(msg.body)
                if(message.sender == nickname) return ;
                messageHandler(message)

            })
            showAddMessage();
        })
    }

    const messageHandler = (message) => {
        if(message.type === 'CHAT'){
            showMessage(message.sender, message.content)
        }
        else if(message.type === 'JOIN'){
            showAddNotification(message.sender, 1)
        }
        else if(message.type === 'LEAVE'){
            showAddNotification(message.sender, 0)
        }
    }
    const showAddNotification = (username, flag) => {
        const messagesContainer = document.getElementById('chatMessages');
        const now = new Date();
        const timeString = `ì˜¤í›„ ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        const message = flag === 1 ? username + "ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤." : username + "ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤."

        const messageHTML = `<div class="date-divider">
                <span>${message}</span>
            </div>`;

        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    const showAddMessage = () => {
        const messagesContainer = document.getElementById('chatMessages');
        const now = new Date();
        const timeString = `ì˜¤í›„ ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        const message = nickname + "ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤."
        userAddMessage()

        const messageHTML = `<div class="date-divider">
                <span>${message}</span>
            </div>`;

        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    const userAddMessage = () => {
        stompClient.send('/app/chat.addUser', {}, JSON.stringify({
            sender: nickname,
            roomId : roomId
        }))
    }

    const showMessage = (sender, content) => {
        const messagesContainer = document.getElementById('chatMessages');
        const now = new Date();
        const timeString = `ì˜¤í›„ ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

        const messageHTML = `<div class="message">
                <div class="message-avatar">
                    <img src="https://ssoads.co.kr/common/img/default_profile.png" alt="">
                </div>
                <div class="message-content">
                    <div class="message-sender">${sender}</div>
                    <div class="message-bubble">${content}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            </div>`;

        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (message) {
            const messagesContainer = document.getElementById('chatMessages');
            const now = new Date();
            const timeString = `ì˜¤í›„ ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                sender: nickname,
                content : message,
                roomId : roomId
            }))

            const messageHTML = `
                    <div class="message own">
                        <div class="message-content">
                            <div class="message-bubble">${message}</div>
                            <div class="message-time">${timeString}</div>
                        </div>
                    </div>
                `;

            messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            input.value = '';
        }
    }
    const laeveRoom = () => {
        if(stompClient && stompClient.connected){
            stompClient.send("/app/chat.leave" , {}, JSON.stringify({
                sender : nickname,
                roomId : roomId
            }))
            stompClient.disconnect()
        }

    }

    window.onload = connect

    window.addEventListener("beforeunload", () => {
        laeveRoom()
    })



    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    document.addEventListener('DOMContentLoaded', function() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
</script>
</body>
</html>