<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ğŸ¾ MyPet ì§€ë„ | ì£¼ë³€ ë™ë¬¼ë³‘ì›</title>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: calc(100vh - 64px); background: #f6f6f6; }
    .bar {
      height: 64px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 16px;
      font-weight: 700;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,.06);
    }

    /* ì˜¤ë²„ë ˆì´ ì¹´ë“œ */
    .ov-wrap {
      position: relative;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      padding: 14px 16px;
      width: 260px;
    }
    .ov-title { font-size: 16px; font-weight: 800; margin: 0 24px 6px 0; }
    .ov-txt { font-size: 13px; color: #333; line-height: 1.4; margin: 2px 0; }
    .ov-close {
      position: absolute;
      right: 8px;
      top: 8px;
      border: 0;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
    }
    .btns { display: flex; gap: 8px; margin-top: 10px; }
    .btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
    }
    .btn:hover { background: #f3f4f6; }
  </style>

  <!-- Kakao JS SDK ë¡œë“œ -->
  <script>
    (function loadKakao(){
      const s=document.createElement('script');
      s.src='https://dapi.kakao.com/v2/maps/sdk.js?appkey=f9dabfab3e52a805008e3beea7d3a98b&autoload=false';
      s.onload=function(){ kakao.maps.load(initMap); };
      s.onerror=function(){ alert('ì¹´ì¹´ì˜¤ SDK ë¡œë“œ ì‹¤íŒ¨(í‚¤/ë„ë©”ì¸/ë„¤íŠ¸ì›Œí¬ í™•ì¸)'); };
      document.head.appendChild(s);
    })();
  </script>

  <script>
    let map, openOverlay=null;

    // ğŸ¾ ë…¸ë€ ë°œë°”ë‹¥ SVG (í•˜ì–€ ë°°ê²½ + ë…¸ë€ ë°œ)
    const PAW_SVG = encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'>
        <circle cx='14' cy='14' r='13' fill='white' stroke='#f1c40f' stroke-width='2'/>
        <circle cx='9' cy='9' r='3' fill='#f1c40f'/>
        <circle cx='19' cy='9' r='3' fill='#f1c40f'/>
        <circle cx='7' cy='14' r='3' fill='#f1c40f'/>
        <circle cx='21' cy='14' r='3' fill='#f1c40f'/>
        <ellipse cx='14' cy='18' rx='5.5' ry='4' fill='#f1c40f'/>
      </svg>
    `);

    function makeMarkerImage() {
      return new kakao.maps.MarkerImage(
        "data:image/svg+xml;charset=UTF-8," + PAW_SVG,
        new kakao.maps.Size(28,28),
        { offset: new kakao.maps.Point(14,28) }
      );
    }

    // ------------------- ì§€ë„ ì´ˆê¸°í™” -------------------
    function initMap(){
      const container=document.getElementById('map');
      const center=new kakao.maps.LatLng(36.632473,127.453143);
      map=new kakao.maps.Map(container,{center,level:5});

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const cur=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
          map.setCenter(cur);
          new kakao.maps.Marker({position:cur}).setMap(map);
          fetchHospitalsAndRender(cur.getLat(), cur.getLng(), 3000);
        },_=>{
          fetchHospitalsAndRender(center.getLat(), center.getLng(), 3000);
        },{enableHighAccuracy:true,timeout:5000});
      }else{
        fetchHospitalsAndRender(center.getLat(), center.getLng(), 3000);
      }
    }

    // ------------------- ë³‘ì› ë°ì´í„° ê°€ì ¸ì˜¤ê¸° -------------------
    function fetchHospitalsAndRender(lat,lng,radius){
      const url=`/api/hospitals?lat=${lat}&lng=${lng}&radius=${radius||3000}`;
      fetch(url)
        .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(json=>{
          const arr = json.items ? json.items : json;
          renderMarkers(arr);
        })
        .catch(err=>{
          console.warn('ì„œë²„ ì‹¤íŒ¨ â†’ mock ì‚¬ìš©', err);
          fetch('/api/hospitals/mock').then(r=>r.json()).then(j=>renderMarkers(j.items||[]))
          .catch(()=>alert('ë³‘ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
        });
    }

    // ------------------- ë§ˆì»¤ í‘œì‹œ -------------------
    function renderMarkers(list){
      list.forEach(h=>{
        const pos=new kakao.maps.LatLng(h.lat, h.lng);
        const marker=new kakao.maps.Marker({
          position:pos,
          image:makeMarkerImage(),
          zIndex:1
        });
        marker.setMap(map);
        kakao.maps.event.addListener(marker,'click',()=>openHospitalOverlay(marker,h));
      });
    }

    // ------------------- ì˜¤ë²„ë ˆì´ (ë‹«ê¸° ê°€ëŠ¥) -------------------
    function openHospitalOverlay(marker,h){
      if(openOverlay){ openOverlay.setMap(null); openOverlay=null; }

      const wrap=document.createElement('div');
      wrap.className='ov-wrap';
      wrap.innerHTML=`
        <button class="ov-close" title="ë‹«ê¸°">âœ•</button>
        <h3 class="ov-title">${escapeHtml(h.name)}</h3>
        <div class="ov-txt">${escapeHtml(h.address||'ì£¼ì†Œ ì •ë³´ ì—†ìŒ')}</div>
        <div class="ov-txt">${escapeHtml(h.phone||'ì „í™”ë²ˆí˜¸ ì—†ìŒ')}</div>
        <div class="btns">
          <a class="btn" target="_blank"
             href="https://map.kakao.com/link/to/${encodeURIComponent(h.name)},${h.lat},${h.lng}">ê¸¸ì°¾ê¸°</a>
          <a class="btn" target="_blank"
             href="https://map.kakao.com/link/map/${encodeURIComponent(h.name)},${h.lat},${h.lng}">ì¹´ì¹´ì˜¤ë§µ</a>
        </div>
      `;

      const ov=new kakao.maps.CustomOverlay({
        content:wrap,
        position:marker.getPosition(),
        xAnchor:0.5,
        yAnchor:1.05,
        zIndex:999
      });
      ov.setMap(map);
      openOverlay=ov;
      wrap.querySelector('.ov-close').onclick=()=>{ ov.setMap(null); openOverlay=null; };
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</head>
<body>
  <div class="bar">ğŸ¾ MyPet ì§€ë„ | ì£¼ë³€ ë™ë¬¼ë³‘ì›</div>
  <div id="map"></div>
</body>
</html>
