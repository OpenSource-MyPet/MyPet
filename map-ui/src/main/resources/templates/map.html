<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>MyPet Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; }
    .overlay-card{width:240px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.15);overflow:hidden}
    .overlay-header{position:relative}
    .overlay-thumb{width:100%;height:130px;object-fit:cover;display:block}
    .overlay-close{position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:50%;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .overlay-body{padding:10px 12px}
    .name{font-weight:700}
    .badge{display:inline-block;margin-left:6px;padding:1px 6px;border:1px solid #e5e7eb;border-radius:999px;font-size:11px;background:#f8fafc}
    .addr{font-size:12px;color:#6b7280;margin-top:4px}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Kakao Maps SDK: JS í‚¤ë§Œ êµì²´ -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f9dabfab3e52a805008e3beea7d3a98b&autoload=false"></script>
  <script>
    // ìƒ˜í”Œ ë°ì´í„° 3ê°œ (ì¶©ë¶ëŒ€ ì¼ëŒ€) â€” imageëŠ” ë¹„ì›Œë‘ê³  ì¢…/IDë¡œ ì‚¬ì§„ ìë™ ìƒì„±
    const PETS = [
      { id:1, name:"Mango", species:"Dog",
        lat:36.632473, lng:127.453143, address:"ì¶©ë¶ëŒ€ ì¤‘ì•™",
        desc:"ìº í¼ìŠ¤ ì‚°ì±… ì¢‹ì•„í•˜ëŠ” 2ì‚´ ë§í‹°ì¦ˆ", image:"" },
      { id:2, name:"Nabi",  species:"Cat",
        lat:36.6239, lng:127.4614, address:"ì¶©ë¶ëŒ€í•™êµë³‘ì›",
        desc:"ê² ë§ì§€ë§Œ í˜¸ê¸°ì‹¬ ë§ì€ ì½”ìˆ", image:"" },
      { id:3, name:"Berry", species:"Dog",
        lat:36.635, lng:127.447, address:"ì²­ì£¼ì‹œ ì„œì›êµ¬ ì¼ëŒ€",
        desc:"ì¥ë‚œê¾¸ëŸ¬ê¸° ë¦¬íŠ¸ë¦¬ë²„", image:"" }
    ];

    // âœ… ì¢…/IDë§ˆë‹¤ ë‹¤ë¥¸ ì‚¬ì§„ì„ ì£¼ëŠ” í—¬í¼
    function photoUrl(pet, w, h) {
      // ê°•ì•„ì§€: placedog.netì€ ?id= ê°’ìœ¼ë¡œ ì´ë¯¸ì§€ê°€ ë‹¬ë¼ì§(ì•ˆì •ì )
      if (pet.species === "Dog") return `https://placedog.net/${w}/${h}?id=${pet.id}`;
      // ê³ ì–‘ì´: cataasëŠ” unique íŒŒë¼ë¯¸í„°ë¡œ ê°ê¸° ë‹¤ë¥¸ ì´ë¯¸ì§€
      return `https://cataas.com/cat?width=${w}&height=${h}&unique=${pet.id}`;
    }
    // ì‹¤íŒ¨ ì‹œ ëŒ€ì²´(ì¢…ë³„ ê¸°ë³¸)
    function fallbackUrl(pet, w, h) {
      return (pet.species === "Dog")
        ? `https://place.dog/${w}/${h}`
        : `https://placekitten.com/${w}/${h}`;
    }

    let map, openOverlay = null;

    kakao.maps.load(function () {
      const center = new kakao.maps.LatLng(36.632473, 127.453143);
      map = new kakao.maps.Map(document.getElementById('map'), { center, level: 6 });

      // ì§€ë„ ë¹ˆ ê³³ í´ë¦­í•˜ë©´ ì—´ë¦° ì˜¤ë²„ë ˆì´ ë‹«ê¸°
      kakao.maps.event.addListener(map, 'click', function(){
        if (openOverlay) { openOverlay.setMap(null); openOverlay = null; }
      });

      // ê° í«ì— ëŒ€í•´ ë§ˆì»¤ + ì˜¤ë²„ë ˆì´ ìƒì„±
      PETS.forEach(pet => {
        const pos = new kakao.maps.LatLng(pet.lat, pet.lng);
        const marker = new kakao.maps.Marker({ position: pos });
        marker.setMap(map);

        const content = document.createElement('div');
        content.className = 'overlay-card';

        // ì—¬ê¸°ì„œ ì¢…/IDë³„ë¡œ ì„œë¡œ ë‹¤ë¥¸ ì´ë¯¸ì§€ ë¶€ì—¬
        const imgSrc = pet.image && pet.image.trim().length > 0
          ? pet.image
          : photoUrl(pet, 400, 280);

        content.innerHTML = `
          <div class="overlay-header">
            <img class="overlay-thumb"
                 src="${imgSrc}"
                 alt="${pet.name}"
                 referrerpolicy="no-referrer">
            <button class="overlay-close" aria-label="close">Ã—</button>
          </div>
          <div class="overlay-body">
            <div class="name">${pet.name}<span class="badge">${pet.species}</span></div>
            <div class="addr">ğŸ“ ${pet.address}</div>
            <div style="font-size:13px;margin-top:4px;color:#374151">${pet.desc}</div>
          </div>
        `;

        // onerrorë¡œ ì¢…ë³„ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ì•ˆì „í•˜ê²Œ ë³µêµ¬
        const imgEl = content.querySelector('.overlay-thumb');
        imgEl.onerror = () => { imgEl.src = fallbackUrl(pet, 400, 280); };

        const overlay = new kakao.maps.CustomOverlay({
          content, position: pos, yAnchor: 1.12, xAnchor: 0.5, clickable: true
        });

        // ë‹«ê¸° ë²„íŠ¼
        content.querySelector('.overlay-close').addEventListener('click', (e) => {
          e.stopPropagation();
          overlay.setMap(null);
          if (openOverlay === overlay) openOverlay = null;
        });

        // ë§ˆì»¤ í´ë¦­ ì‹œ: ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ë‹«ê³  ì´ ì˜¤ë²„ë ˆì´ ì—´ê¸°
        kakao.maps.event.addListener(marker, 'click', function(){
          if (openOverlay) openOverlay.setMap(null);
          overlay.setMap(map);
          openOverlay = overlay;
          map.panTo(pos);
        });
      });
    });
  </script>
</body>
</html>
